#!/usr/bin/env sh
set -eu

# Reject pushing version tags that don't match TestRift.NUnit.csproj
#
# Expected tag format: vX.Y.Z (or X.Y.Z)

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [ -z "$repo_root" ]; then
  exit 0
fi

csproj="$repo_root/src/TestRift.NUnit/TestRift.NUnit.csproj"
if [ ! -f "$csproj" ]; then
  exit 0
fi

pkg_version=""

read_csproj_version() {
  sed -n 's/.*<Version>\(.*\)<\/Version>.*/\1/p' "$csproj" | head -n 1
}

while read -r local_ref local_sha remote_ref remote_sha; do
  case "$local_ref" in
    refs/tags/*)
      tag="${local_ref#refs/tags/}"
      case "$tag" in
        v*) tag_version="${tag#v}" ;;
        *) tag_version="$tag" ;;
      esac

      case "$tag_version" in
        ""|*[!0-9.]*)
          # Ignore non-version-ish tags (e.g. "docs", "nightly", etc.)
          continue
          ;;
      esac

      if [ -z "$pkg_version" ]; then
        pkg_version="$(read_csproj_version || true)"
        if [ -z "${pkg_version:-}" ]; then
          echo "ERROR: Unable to read package version from $csproj (expected: <Version>X.Y.Z</Version>)." >&2
          exit 1
        fi
      fi

      if [ "$tag_version" != "$pkg_version" ]; then
        echo "ERROR: Refusing to push tag '$tag' (version $tag_version) because TestRift.NUnit.csproj version is '$pkg_version'." >&2
        echo "Fix one of these and retry:" >&2
        echo "  - update $csproj <Version>" >&2
        echo "  - recreate the tag to match the version (e.g. v$pkg_version)" >&2
        exit 1
      fi
      ;;
  esac
done

exit 0


